{% extends 'admin/base.html' %}

{% block admin_content %}
<div class="header">
    <h1>إدارة التطبيقات</h1>
    <button class="btn" onclick="openModal('addModal')">
        <svg fill="currentColor" viewBox="0 0 20 20" width="16" height="16" style="margin-left: 8px;"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
        إضافة تطبيق
    </button>
</div>

<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>الصورة</th>
                <th>الاسم</th>
                <th>الوصف</th>
                <th>القسم</th>
                <th>الإجراءات</th>
            </tr>
        </thead>
        <tbody>
            {% for app in apps %}
            <tr>
                <td><img src="{{ app.image_url }}" alt="{{ app.name }}"></td>
                <td>{{ app.name }}</td>
                <td>{{ app.description[:50] }}{% if app.description|length > 50 %}...{% endif %}</td>
                <td>{{ app.category.name if app.category else 'غير محدد' }}</td>
                <td>
                    <div class="actions">
                        <button class="btn btn-success" onclick="openEditModal({{ app.id }}, '{{ app.name }}', '{{ app.description }}', '{{ app.image_url }}', '{{ app.download_link }}', {{ app.category_id }})">تعديل</button>
                        <a href="{{ url_for('admin_delete_app', id=app.id) }}" class="btn btn-danger" onclick="return confirm('هل أنت متأكد من الحذف؟')">حذف</a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% if not apps %}
    <p style="text-align: center; padding: 40px; color: #c9a8e8;">لا توجد تطبيقات حالياً</p>
    {% endif %}
</div>

<div id="addModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>إضافة تطبيق جديد</h3>
            <button class="modal-close" onclick="closeModal('addModal')">&times;</button>
        </div>
        <form action="{{ url_for('admin_add_app') }}" method="POST">
            <div class="form-group">
                <label>اسم التطبيق</label>
                <input type="text" name="name" required placeholder="مثال: PUBG MOBILE">
            </div>
            <div class="form-group">
                <label>الوصف</label>
                <textarea name="description" rows="3" placeholder="وصف التطبيق..."></textarea>
            </div>
            <div class="form-group">
                <label>رابط الصورة</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="url" name="image_url" id="add_image_url" required placeholder="https://example.com/image.png" style="flex: 1;">
                    <button type="button" class="upload-btn" onclick="document.getElementById('add_image_upload').click()">
                        <svg fill="currentColor" viewBox="0 0 20 20" width="16" height="16">
                            <path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13H5.5z"></path>
                            <path d="M9 13h2v5a1 1 0 11-2 0v-5z"></path>
                        </svg>
                        رفع صورة
                    </button>
                </div>
                <input type="file" id="add_image_upload" accept="image/*" style="display: none;" onchange="uploadImage(this, 'add_image_url')">
            </div>
            <div class="form-group">
                <label>رابط التحميل</label>
                <input type="url" name="download_link" required placeholder="https://example.com/download">
            </div>
            <div class="form-group">
                <label>القسم</label>
                <select name="category_id" required>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn" style="width: 100%;">إضافة</button>
        </form>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>تعديل التطبيق</h3>
            <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
        </div>
        <form id="editForm" method="POST">
            <div class="form-group">
                <label>اسم التطبيق</label>
                <input type="text" name="name" id="edit_name" required>
            </div>
            <div class="form-group">
                <label>الوصف</label>
                <textarea name="description" id="edit_description" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>رابط الصورة</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="url" name="image_url" id="edit_image_url" required style="flex: 1;">
                    <button type="button" class="upload-btn" onclick="document.getElementById('edit_image_upload').click()">
                        <svg fill="currentColor" viewBox="0 0 20 20" width="16" height="16">
                            <path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13H5.5z"></path>
                            <path d="M9 13h2v5a1 1 0 11-2 0v-5z"></path>
                        </svg>
                        رفع صورة
                    </button>
                </div>
                <input type="file" id="edit_image_upload" accept="image/*" style="display: none;" onchange="uploadImage(this, 'edit_image_url')">
            </div>
            <div class="form-group">
                <label>رابط التحميل</label>
                <input type="url" name="download_link" id="edit_download_link" required>
            </div>
            <div class="form-group">
                <label>القسم</label>
                <select name="category_id" id="edit_category_id" required>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn" style="width: 100%;">حفظ التعديلات</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function openEditModal(id, name, description, image_url, download_link, category_id) {
    document.getElementById('editForm').action = '/admin/apps/edit/' + id;
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_description').value = description;
    document.getElementById('edit_image_url').value = image_url;
    document.getElementById('edit_download_link').value = download_link;
    document.getElementById('edit_category_id').value = category_id;
    openModal('editModal');
}
</script>
{% endblock %}



<script>
function uploadImage(input, targetInputId) {
    const file = input.files[0];
    if (!file) return;
    
    // التحقق من نوع الملف
    const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        alert('نوع الملف غير مسموح به. استخدم: PNG, JPG, JPEG, GIF, WEBP');
        return;
    }
    
    // التحقق من حجم الملف (16MB max)
    if (file.size > 16 * 1024 * 1024) {
        alert('حجم الملف كبير جداً. الحد الأقصى 16 ميجابايت');
        return;
    }
    
    const formData = new FormData();
    formData.append('image', file);
    
    // إظهار رسالة التحميل
    const targetInput = document.getElementById(targetInputId);
    const originalValue = targetInput.value;
    targetInput.value = 'جاري رفع الصورة...';
    targetInput.disabled = true;
    
    fetch('/admin/upload-image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            targetInput.value = data.url;
            targetInput.disabled = false;
            // إظهار معاينة الصورة
            showImagePreview(data.url, targetInputId);
        } else {
            alert('خطأ: ' + data.error);
            targetInput.value = originalValue;
            targetInput.disabled = false;
        }
    })
    .catch(error => {
        alert('حدث خطأ أثناء رفع الصورة');
        console.error('Error:', error);
        targetInput.value = originalValue;
        targetInput.disabled = false;
    });
}

function showImagePreview(url, inputId) {
    const input = document.getElementById(inputId);
    let preview = input.parentElement.querySelector('.image-preview');
    
    if (!preview) {
        preview = document.createElement('img');
        preview.className = 'image-preview';
        preview.style.cssText = 'width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-top: 10px; border: 2px solid rgba(155, 77, 202, 0.3);';
        input.parentElement.appendChild(preview);
    }
    
    preview.src = url;
}
</script>

<style>
.upload-btn {
    padding: 8px 16px;
    background: linear-gradient(135deg, #9b4dca 0%, #4a1a6b 100%);
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.upload-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(155, 77, 202, 0.4);
}

.upload-btn svg {
    fill: #fff;
}
</style>
